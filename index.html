<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin RPG</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; --danger: #ef4444; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 1000px; width: 100%; }
        
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 20px; }
        .status-badge { background: rgba(37, 99, 235, 0.2); color: #60a5fa; padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 1px solid var(--primary); }

        .nav { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
        .nav-btn { flex: 1; min-width: 110px; background: var(--card); border: 1px solid var(--border); color: #94a3b8; padding: 15px; cursor: pointer; border-radius: 10px; font-weight: 600; transition: all 0.3s; }
        .nav-btn:hover { border-color: var(--primary); color: white; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); }

        .tab { display: none; animation: fadeIn 0.3s; }
        .tab.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 25px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        h2 { margin-top: 0; color: #60a5fa; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        label { display: block; margin: 15px 0 5px; font-size: 0.9em; color: #cbd5e1; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 12px; background: #020617; border: 1px solid var(--border); color: white; border-radius: 8px; font-family: inherit; transition: 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; }
        
        button.action { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.2s; }
        button.action:hover { background: #1d4ed8; }

        .item-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
        .item:hover { border-color: var(--border); background: rgba(255,255,255,0.05); }
        
        .del-btn { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        #qr { border: 8px solid white; border-radius: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-gamepad"></i> RPG Admin Pro</h1>
        <div class="status-badge" id="status">Conectando...</div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="tab('dash')">Dashboard</button>
        <button class="nav-btn" onclick="tab('rpg')">Config Jogo</button>
        <button class="nav-btn" onclick="tab('mob')">Monstros</button>
        <button class="nav-btn" onclick="tab('item')">Itens</button>
        <button class="nav-btn" onclick="tab('cmd')">Comandos</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dash" class="tab active">
        <div class="card" style="text-align:center;">
            <h3>Conex√£o WhatsApp</h3>
            <div style="padding:20px;">
                <img id="qr" src="" style="display:none; max-width:250px; margin:auto;">
                <p id="qr-msg">Aguardando c√≥digo QR...</p>
            </div>
        </div>
    </div>

    <!-- RPG CONFIGS -->
    <div id="rpg" class="tab">
        <div class="card">
            <h2>‚öôÔ∏è Configura√ß√µes Gerais</h2>
            <form id="form-config">
                <div class="grid-2">
                    <div>
                        <label>Status do RPG</label>
                        <select name="active"><option value="true">Ativado</option><option value="false">Desativado</option></select>
                    </div>
                    <div>
                        <label>Cooldown Minera√ß√£o (s)</label>
                        <input type="number" name="cooldown" value="60">
                    </div>
                </div>
                <label>Grupo do Jogo</label>
                <select name="targetGroup" class="group-select"><option value="">Carregando...</option></select>
                <button class="action">Salvar Configura√ß√µes</button>
            </form>
        </div>

        <div class="card">
            <h2>‚õèÔ∏è Drops de Minera√ß√£o</h2>
            <div class="grid-3">
                <input id="d-name" placeholder="Nome (Ex: Rubi)">
                <input id="d-icon" placeholder="√çcone (Ex: üî¥)">
                <input id="d-chance" type="number" placeholder="Chance %">
            </div>
            <div class="grid-2" style="margin-top:10px">
                <input id="d-min" type="number" placeholder="Min Qtd">
                <input id="d-max" type="number" placeholder="Max Qtd">
            </div>
            <input id="d-tier" type="number" placeholder="Tier (1=Comum, 3=Raro)" style="margin-top:10px">
            <button class="action" onclick="addDrop()">+ Adicionar Drop</button>
            <div id="list-drops" class="item-list"></div>
        </div>
    </div>

    <!-- MONSTERS -->
    <div id="mob" class="tab">
        <div class="card">
            <h2>üëπ Besti√°rio (Ca√ßa)</h2>
            <div class="grid-3">
                <input id="m-name" placeholder="Nome (Ex: Lobo)">
                <input id="m-icon" placeholder="√çcone (Ex: üê∫)">
                <input id="m-drop" placeholder="Drop (Ex: Couro)">
            </div>
            <div class="grid-3" style="margin-top:10px">
                <input id="m-hp" type="number" placeholder="HP (Vida)">
                <input id="m-atk" type="number" placeholder="Ataque">
                <input id="m-xp" type="number" placeholder="XP Ganho">
            </div>
            <input id="m-chance" type="number" placeholder="Chance de Encontro %" style="margin-top:10px">
            <button class="action" onclick="addMob()">+ Adicionar Monstro</button>
            <div id="list-mobs" class="item-list"></div>
        </div>
    </div>

    <!-- CRAFTS / ITEMS -->
    <div id="item" class="tab">
        <div class="card">
            <h2>üõ†Ô∏è Receitas de Craft</h2>
            <div class="grid-2">
                <input id="c-key" placeholder="Comando (ex: pocao_vida)">
                <input id="c-name" placeholder="Nome (ex: Po√ß√£o de Vida)">
            </div>
            <label>Tipo de Item</label>
            <select id="c-type">
                <option value="weapon">Arma (D√° Ataque)</option>
                <option value="armor">Armadura (D√° Defesa)</option>
                <option value="consumable">Consum√≠vel (Cura HP)</option>
            </select>
            
            <div class="grid-2" style="margin-top:10px">
                <input id="c-val" type="number" placeholder="Valor (Atk/Def/Cura)">
                <input id="c-cost" placeholder="Custo (Ex: Ouro:1, Carne:2)">
            </div>
            <p style="font-size:0.8em; color:#64748b; margin-top:5px">Separe custos por v√≠rgula. Use nomes exatos dos drops.</p>

            <button class="action" onclick="addCraft()">+ Criar Receita</button>
            <div id="list-crafts" class="item-list"></div>
        </div>
    </div>

    <!-- COMMANDS -->
    <div id="cmd" class="tab">
        <div class="card">
            <h2>Comandos Gerais</h2>
            <form id="form-cmd">
                <input name="trigger" placeholder="!gatilho" required>
                <input type="hidden" name="type" value="text">
                <textarea name="response" placeholder="Resposta..." style="margin-top:10px"></textarea>
                <select name="targetGroup" class="group-select" style="margin-top:10px"><option value="all">Todos</option></select>
                <button class="action">Salvar</button>
            </form>
            <div id="list-cmds" class="item-list"></div>
        </div>
    </div>

</div>

<script>
    const socket = io();
    let db = { rpg: { drops: [], crafts: [], monsters: [] }, commands: [] };

    function tab(id) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // SOCKETS
    socket.on('status', s => document.getElementById('status').innerText = s);
    socket.on('qr', u => { 
        const el = document.getElementById('qr'); 
        el.src = u || ''; 
        el.style.display = u ? 'block' : 'none';
        document.getElementById('qr-msg').innerText = u ? 'Escaneie agora:' : 'Conectado ‚úÖ';
    });
    socket.on('groups', g => {
        const h = '<option value="">Selecione...</option>' + g.map(x=>`<option value="${x.id}">${x.subject}</option>`).join('');
        document.querySelectorAll('.group-select').forEach(s => s.innerHTML = h);
        if(db.rpg && db.rpg.targetGroup) document.querySelector('[name="targetGroup"]').value = db.rpg.targetGroup;
    });

    // DATA LOADING
    async function load() {
        db = await (await fetch('/api/data')).json();
        const rpg = db.rpg || {};

        // Settings
        const form = document.getElementById('form-config');
        form.active.value = rpg.active ? "true" : "false";
        form.cooldown.value = rpg.cooldown || 60;

        // Render Lists
        renderList('list-drops', rpg.drops, (d,i) => `<span>${d.icon} ${d.name} (${d.chance}%)</span>`, 'drops');
        renderList('list-mobs', rpg.monsters, (m,i) => `<span>${m.icon} ${m.name} (HP:${m.hp})</span>`, 'monsters');
        renderList('list-crafts', rpg.crafts, (c,i) => {
            let info = c.type==='weapon'?'‚öîÔ∏è':c.type==='armor'?'üõ°Ô∏è':'üß™';
            return `<span>${info} ${c.name} (!fazer ${c.key})</span>`;
        }, 'crafts');
        renderList('list-cmds', db.commands, (c,i) => `<span><b>${c.trigger}</b></span>`, 'commands', true);
    }

    function renderList(id, arr, templateFn, type, isCmd=false) {
        document.getElementById(id).innerHTML = (arr||[]).map((item, i) => `
            <div class="item">
                ${templateFn(item, i)}
                <button class="del-btn" onclick="${isCmd ? 'delCmd('+i+')' : 'delRpg(\''+type+'\','+i+')'}"><i class="fas fa-trash"></i></button>
            </div>
        `).join('');
    }

    // ACTIONS
    async function saveRpg() { 
        await fetch('/api/save-rpg', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(db.rpg)}); 
        load(); 
    }

    document.getElementById('form-config').onsubmit = function(e) {
        e.preventDefault();
        db.rpg.active = this.active.value === "true";
        db.rpg.cooldown = parseInt(this.cooldown.value);
        db.rpg.targetGroup = this.targetGroup.value;
        saveRpg();
        alert('Configura√ß√µes salvas!');
    }

    function addDrop() {
        const name = document.getElementById('d-name').value;
        if(!name) return;
        db.rpg.drops.push({
            name, icon: document.getElementById('d-icon').value,
            chance: parseFloat(document.getElementById('d-chance').value),
            min: parseInt(document.getElementById('d-min').value),
            max: parseInt(document.getElementById('d-max').value),
            tier: parseInt(document.getElementById('d-tier').value)
        });
        saveRpg();
    }

    function addMob() {
        const name = document.getElementById('m-name').value;
        if(!name) return;
        db.rpg.monsters.push({
            name, icon: document.getElementById('m-icon').value,
            drop: document.getElementById('m-drop').value,
            hp: parseInt(document.getElementById('m-hp').value),
            atk: parseInt(document.getElementById('m-atk').value),
            xp: parseInt(document.getElementById('m-xp').value),
            chance: parseFloat(document.getElementById('m-chance').value)
        });
        saveRpg();
    }

    function addCraft() {
        const key = document.getElementById('c-key').value;
        if(!key) return;
        const type = document.getElementById('c-type').value;
        const val = parseInt(document.getElementById('c-val').value);
        const obj = {
            key, name: document.getElementById('c-name').value, type,
            cost: document.getElementById('c-cost').value.split(',').map(p => { const[i,q]=p.split(':'); return {item:i.trim(), qtd:parseInt(q)}; })
        };
        if(type==='weapon') obj.atk = val;
        if(type==='armor') obj.def = val;
        if(type==='consumable') obj.heal = val;
        db.rpg.crafts.push(obj);
        saveRpg();
    }

    function delRpg(type, index) { db.rpg[type].splice(index, 1); saveRpg(); }

    // Commands
    document.getElementById('form-cmd').onsubmit = async function(e) {
        e.preventDefault();
        await fetch('/api/command', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(Object.fromEntries(new FormData(this)))});
        this.reset(); load();
    }
    async function delCmd(index) {
        await fetch('/api/delete-command', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({index})});
        load();
    }

    load();
</script>
</body>
</html>