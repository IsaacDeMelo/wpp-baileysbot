<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigma Bot Admin</title>
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #8b5cf6; /* Roxo Gemini */
            --primary-hover: #7c3aed;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --input-bg: #0b1120;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --danger: #ef4444;
            --success: #10b981;
            --gradient: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
        }

        * { box-sizing: border-box; outline: none; }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; min-height: 100vh; }
        .container { max-width: 1200px; width: 100%; }

        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand i { font-size: 1.8em; color: var(--primary); }
        .brand h1 { margin: 0; font-size: 1.5em; font-weight: 700; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .status-badge { background: rgba(139, 92, 246, 0.1); color: var(--primary); padding: 8px 20px; border-radius: 30px; font-weight: 600; border: 1px solid rgba(139, 92, 246, 0.3); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 10px var(--primary); }
        .status-dot.offline { background: var(--danger); box-shadow: 0 0 10px var(--danger); }

        /* NAVIGATION */
        .nav { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
        .nav-btn { flex: 1; min-width: 120px; background: var(--card-bg); border: 1px solid var(--border); color: var(--text-muted); padding: 15px; cursor: pointer; border-radius: 12px; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .nav-btn:hover { border-color: var(--primary); color: white; transform: translateY(-2px); }
        .nav-btn.active { background: var(--gradient); color: white; border-color: transparent; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }

        /* TABS */
        .tab { display: none; animation: fadeIn 0.4s ease-out; }
        .tab.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & FORMS */
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 20px; position: relative; }
        h2 { margin-top: 0; color: white; font-size: 1.3em; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        label { display: block; margin: 15px 0 8px; font-size: 0.9em; color: var(--text-muted); font-weight: 500; }
        input, select, textarea { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid var(--border); color: white; border-radius: 8px; font-family: inherit; font-size: 0.95em; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
        
        button.action { width: 100%; padding: 14px; background: var(--gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 25px; font-size: 1em; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        button.action:hover { opacity: 0.9; transform: scale(0.99); }

        /* FILE UPLOAD */
        .file-upload { border: 2px dashed var(--border); background: rgba(255,255,255,0.02); padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .file-upload:hover { border-color: var(--primary); background: rgba(139, 92, 246, 0.05); }

        /* LIST & SEARCH */
        .search-bar { position: relative; margin-bottom: 20px; }
        .search-bar input { padding-left: 40px; }
        .search-bar i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .campaign-item { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; transition: 0.2s; }
        .campaign-item:hover { border-color: var(--border); background: rgba(255,255,255,0.05); }
        
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #475569; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stats-row { display: flex; gap: 15px; margin-top: 10px; font-size: 0.85em; color: var(--text-muted); flex-wrap: wrap; }
        .stats-row span { display: flex; align-items: center; gap: 5px; background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 6px; }

        /* QR CODE */
        #qr-container { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 250px; }
        #qr { border: 8px solid white; border-radius: 12px; max-width: 200px; display: none; }

        /* AI SPECIFIC */
        .ai-badge { background: linear-gradient(90deg, #8b5cf6, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">
            <i class="fas fa-robot"></i>
            <div>
                <h1>Sigma Bot AI</h1>
                <span style="font-size:0.8em; color:var(--text-muted)">Automa√ß√£o & Intelig√™ncia Artificial</span>
            </div>
        </div>
        <div class="status-badge" id="status-badge">
            <div class="status-dot" id="status-dot"></div>
            <span id="status-text">Conectando...</span>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="tab('dash')"><i class="fas fa-chart-pie"></i> Dash</button>
        <button class="nav-btn" onclick="tab('create')"><i class="fas fa-bullhorn"></i> Criar Campanha</button>
        <button class="nav-btn" onclick="tab('list')"><i class="fas fa-list"></i> Campanhas</button>
        <button class="nav-btn" onclick="tab('ai')"><i class="fas fa-brain"></i> Configurar IA</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dash" class="tab active">
        <div class="grid-2">
            <div class="card">
                <h2><i class="fas fa-chart-line"></i> M√©tricas Gerais</h2>
                <div style="display: flex; justify-content: space-around; text-align: center; padding: 20px 0;">
                    <div>
                        <h1 id="total-sent" style="margin:0; font-size:2.5em; color:var(--success)">0</h1>
                        <span style="color:var(--text-muted)">Enviadas</span>
                    </div>
                    <div>
                        <h1 id="total-campaigns" style="margin:0; font-size:2.5em; color:var(--primary)">0</h1>
                        <span style="color:var(--text-muted)">Campanhas</span>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2><i class="fas fa-qrcode"></i> Conex√£o WhatsApp</h2>
                <div id="qr-container">
                    <img id="qr" src="">
                    <i id="check-icon" class="fas fa-check-circle" style="font-size:4em; color:var(--success); display:none;"></i>
                    <p id="qr-msg" style="margin-top:15px; color:var(--text-muted)">Aguardando...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CRIAR CAMPANHA -->
    <div id="create" class="tab">
        <div class="card">
            <h2><i class="fas fa-plus-circle"></i> Nova Divulga√ß√£o</h2>
            <form id="form-campaign">
                <label>Nome da Campanha</label>
                <input name="name" placeholder="Ex: Promo√ß√£o de Natal" required>

                <div class="grid-2">
                    <div>
                        <label>Texto (Caption)</label>
                        <textarea name="text" rows="5" placeholder="Mensagem..."></textarea>
                    </div>
                    <div>
                        <label>M√≠dia</label>
                        <div class="file-upload" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size:2em; color:var(--primary)"></i>
                            <p id="file-name" style="margin:10px 0 0; font-size:0.8em">Selecione Imagem/V√≠deo</p>
                            <input type="file" id="file-input" name="media" style="display:none;" accept="image/*,video/*">
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label>Intervalo (Min)</label>
                        <input type="number" name="interval" value="30" min="1" required>
                    </div>
                    <div>
                        <label>Limite Di√°rio</label>
                        <input type="number" name="maxPerDay" value="100" required>
                    </div>
                </div>

                <div class="grid-2">
                    <div>
                        <label>In√≠cio (Hora)</label>
                        <input type="time" name="startTime" value="09:00" required>
                    </div>
                    <div>
                        <label>Dura√ß√£o (Dias)</label>
                        <input type="number" name="durationDays" value="7" required>
                    </div>
                </div>

                <label>Grupos Alvo (Segure CTRL para selecionar v√°rios)</label>
                <select name="targetGroups" class="group-select" multiple style="height: 150px;"></select>

                <button type="submit" class="action">Salvar Campanha</button>
            </form>
        </div>
    </div>

    <!-- LISTAR CAMPANHAS -->
    <div id="list" class="tab">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2><i class="fas fa-tasks"></i> Gerenciar</h2>
                <button onclick="loadCampaigns()" style="background:transparent; border:1px solid var(--border); color:white; padding:5px 10px; border-radius:6px; cursor:pointer;"><i class="fas fa-sync"></i></button>
            </div>
            
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Pesquisar campanha..." onkeyup="filterCampaigns()">
            </div>

            <div id="campaign-list"></div>
        </div>
    </div>

    <!-- CONFIGURAR IA (GEMINI) -->
    <div id="ai" class="tab">
        <div class="card">
            <h2><i class="fas fa-brain"></i> Intelig√™ncia Artificial <span class="ai-badge">GEMINI</span></h2>
            <p style="color:var(--text-muted); font-size:0.9em; margin-bottom:20px;">
                Configure a base de conhecimento da IA. Ela responder√° com base nessas informa√ß√µes quando o bot for marcado nos grupos selecionados.
            </p>
            
            <form id="form-ai">
                <label>Diretrizes e Informa√ß√µes da Empresa (Contexto)</label>
                <textarea id="ai-context" rows="10" placeholder="Ex: Voc√™ √© o atendente da Empresa X. Vendemos carros. Nossos pre√ßos s√£o... Se perguntarem sobre garantia, responda que..."></textarea>
                
                <label>Grupos onde a IA pode responder (Whitelist)</label>
                <select id="ai-groups" class="group-select" multiple style="height: 150px;"></select>
                <p style="font-size:0.8em; color:var(--text-muted)">A IA s√≥ responder√° men√ß√µes (@bot) nestes grupos.</p>

                <button type="submit" class="action">Salvar Configura√ß√µes da IA</button>
            </form>
        </div>
    </div>

</div>

<script>
    const socket = io();
    let allGroups = [];

    // --- NAVEGA√á√ÉO ---
    function tab(id) {
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        
        if(id === 'list') loadCampaigns();
        if(id === 'ai') loadAIConfig();
        if(id === 'dash') updateStats();
    }

    // --- SOCKETS ---
    socket.on('status', s => {
        const txt = document.getElementById('status-text');
        const dot = document.getElementById('status-dot');
        txt.innerText = s;
        if(s.includes('Online')) {
            dot.classList.remove('offline');
            document.getElementById('qr').style.display = 'none';
            document.getElementById('check-icon').style.display = 'block';
            document.getElementById('qr-msg').innerText = 'Conectado e Operando';
        } else {
            dot.classList.add('offline');
            document.getElementById('check-icon').style.display = 'none';
        }
    });

    socket.on('qr', u => {
        const qrEl = document.getElementById('qr');
        const msg = document.getElementById('qr-msg');
        if(u) {
            qrEl.src = u; qrEl.style.display = 'block';
            document.getElementById('check-icon').style.display = 'none';
            msg.innerText = 'Escaneie o QR Code';
        } else {
            qrEl.style.display = 'none';
        }
    });

    socket.on('groups', g => {
        allGroups = g;
        const options = g.map(x => `<option value="${x.id}">${x.subject}</option>`).join('');
        document.querySelectorAll('.group-select').forEach(s => s.innerHTML = options);
    });

    // --- UX ARQUIVO ---
    document.getElementById('file-input').onchange = function() {
        document.getElementById('file-name').innerText = this.files[0] ? this.files[0].name : 'Arquivo Selecionado';
    };

    // --- CAMPANHAS (CRIAR) ---
    document.getElementById('form-campaign').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const select = this.querySelector('select');
        const selected = Array.from(select.selectedOptions).map(o => o.value);
        if(!selected.length) return alert('Selecione ao menos um grupo!');
        
        formData.delete('targetGroups');
        formData.append('targetGroups', JSON.stringify(selected));

        const btn = this.querySelector('button');
        const oldTxt = btn.innerText;
        btn.innerText = 'Salvando...'; btn.disabled = true;

        try {
            const res = await fetch('/api/campaign', { method: 'POST', body: formData });
            if(res.ok) {
                alert('Campanha salva com sucesso!');
                this.reset();
                document.getElementById('file-name').innerText = 'Selecione Imagem/V√≠deo';
                tab('list');
            } else throw new Error('Falha no servidor');
        } catch(err) {
            alert('Erro ao salvar: ' + err.message);
        } finally {
            btn.innerText = oldTxt; btn.disabled = false;
        }
    };

    // --- CAMPANHAS (LISTAR) ---
    async function loadCampaigns() {
        const res = await fetch('/api/campaigns');
        const data = await res.json();
        const container = document.getElementById('campaign-list');
        
        if(!data.length) { container.innerHTML = '<p style="text-align:center;color:#64748b">Nenhuma campanha.</p>'; return; }

        container.innerHTML = data.map(c => {
            const start = new Date(c.createdAt).toLocaleDateString();
            const end = new Date(c.endDate).toLocaleDateString();
            const expired = new Date() > new Date(c.endDate);
            const statusColor = (c.active && !expired) ? 'var(--success)' : 'var(--danger)';

            return `
            <div class="campaign-item" data-name="${c.name.toLowerCase()}">
                <div style="flex:1">
                    <h3 style="margin:0 0 5px 0; color:${statusColor}">${c.name}</h3>
                    <p style="margin:0; font-size:0.9em; color:#ccc">${c.text ? c.text.substring(0,50)+'...' : 'Apenas M√≠dia'}</p>
                    <div class="stats-row">
                        <span><i class="far fa-calendar"></i> ${start} at√© ${end}</span>
                        <span><i class="fas fa-clock"></i> In√≠cio: ${c.config.startTime}</span>
                        <span><i class="fas fa-paper-plane"></i> Hoje: ${c.stats.sentToday}/${c.config.maxPerDay}</span>
                        <span><i class="fas fa-check-double"></i> Total: ${c.stats.sentTotal}</span>
                    </div>
                </div>
                <div style="text-align:right">
                     <label class="toggle-switch">
                        <input type="checkbox" ${c.active && !expired ? 'checked' : ''} ${expired ? 'disabled' : ''} onchange="toggleCamp('${c._id}', this.checked)">
                        <span class="slider" style="${expired?'opacity:0.5':''}"></span>
                    </label>
                    <div style="margin-top:10px;">
                        <button onclick="deleteCamp('${c._id}')" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function filterCampaigns() {
        const term = document.getElementById('search-input').value.toLowerCase();
        document.querySelectorAll('.campaign-item').forEach(item => {
            item.style.display = item.dataset.name.includes(term) ? 'flex' : 'none';
        });
    }

    async function toggleCamp(id, val) { await fetch('/api/toggle', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, active:val}) }); }
    async function deleteCamp(id) { if(confirm('Apagar campanha?')) { await fetch('/api/delete-campaign', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id}) }); loadCampaigns(); } }

    async function updateStats() {
        const res = await fetch('/api/campaigns');
        const data = await res.json();
        document.getElementById('total-campaigns').innerText = data.length;
        document.getElementById('total-sent').innerText = data.reduce((a,b)=>a+(b.stats.sentTotal||0),0);
    }

    // --- IA CONFIG ---
    async function loadAIConfig() {
        try {
            const res = await fetch('/api/ai-config');
            const data = await res.json();
            if(data) {
                document.getElementById('ai-context').value = data.systemInstruction || '';
                // Selecionar os grupos salvos
                const select = document.getElementById('ai-groups');
                Array.from(select.options).forEach(opt => {
                    opt.selected = data.targetGroups.includes(opt.value);
                });
            }
        } catch(e) { console.log('Sem config de IA ainda'); }
    }

    document.getElementById('form-ai').onsubmit = async function(e) {
        e.preventDefault();
        const context = document.getElementById('ai-context').value;
        const select = document.getElementById('ai-groups');
        const groups = Array.from(select.selectedOptions).map(o => o.value);

        const btn = this.querySelector('button');
        btn.innerText = 'Salvando...'; btn.disabled = true;

        await fetch('/api/ai-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ systemInstruction: context, targetGroups: groups })
        });

        alert('Configura√ß√µes da IA salvas! üß†');
        btn.innerText = 'Salvar Configura√ß√µes da IA'; btn.disabled = false;
    };
</script>
</body>
</html>