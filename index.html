<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sigma Bot Admin</title>
    
    <!-- Libs -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #a855f7;
            --bg: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        * { box-sizing: border-box; outline: none; }
        body { 
            background: var(--bg); 
            background-image: radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(168, 85, 247, 0.15) 0%, transparent 20%);
            color: var(--text); 
            font-family: 'Outfit', sans-serif; 
            margin: 0; 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
        }

        .main-wrapper {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 20px;
        }

        /* --- Header Glass --- */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 20px 30px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .brand h1 { margin: 0; font-size: 1.5rem; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .status-pill { padding: 8px 16px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); box-shadow: 0 0 10px currentColor; transition: 0.3s; }
        .dot.online { background: var(--success); color: var(--success); }
        .dot.offline { background: var(--danger); color: var(--danger); }

        /* --- Content Layout --- */
        .content-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .content-grid { grid-template-columns: 1fr; }
            .header { flex-direction: column; gap: 15px; text-align: center; }
        }

        /* --- Sidebar --- */
        .sidebar {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px;
            height: fit-content;
        }

        .nav-btn {
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            text-align: left;
            font-size: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); padding-left: 20px; }
        .nav-btn.active { background: var(--gradient); color: white; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }

        /* --- Panels --- */
        .panel { display: none; animation: fadeUp 0.4s ease; }
        .panel.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        h2 { margin-top: 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; font-weight: 400; color: white; display: flex; align-items: center; gap: 10px; }
        
        /* Inputs & Forms */
        label { display: block; margin: 15px 0 8px; font-size: 0.9em; color: var(--text-muted); }
        input, select, textarea { 
            width: 100%; padding: 12px; 
            background: rgba(0,0,0,0.3); 
            border: 1px solid var(--glass-border); 
            color: white; border-radius: 10px; 
            font-family: inherit; transition: 0.3s; 
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        .btn-primary {
            width: 100%; padding: 14px; background: var(--gradient);
            color: white; border: none; border-radius: 10px;
            font-weight: 600; cursor: pointer; margin-top: 20px;
            transition: 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-2px); }

        /* Logs Terminal */
        #logs-container {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border-radius: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 0.85rem;
            border: 1px solid #333;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px dashed #333; padding-bottom: 2px; }

        /* QR Code */
        .qr-wrapper { text-align: center; padding: 20px; min-height: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #qr-img { border: 10px solid white; border-radius: 15px; max-width: 200px; }

        /* Campaign List */
        .campaign-item {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .campaign-item:hover { border-color: var(--primary); background: rgba(255,255,255,0.05); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    </style>
</head>
<body>

<div class="main-wrapper">
    <!-- Header -->
    <div class="header">
        <div class="brand">
            <h1><i class="fas fa-robot"></i> Sigma Bot</h1>
        </div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <div class="status-pill">
                <div class="dot" id="status-dot"></div>
                <span id="status-text">Conectando...</span>
            </div>
            <button onclick="logout()" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; padding: 8px 15px; border-radius: 8px; cursor: pointer;">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </div>

    <div class="content-grid">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <button class="nav-btn active" onclick="showPanel('dash', this)"><i class="fas fa-chart-pie"></i> Dashboard</button>
            <button class="nav-btn" onclick="showPanel('create', this)"><i class="fas fa-plus-circle"></i> Criar Campanha</button>
            <button class="nav-btn" onclick="showPanel('list', this)"><i class="fas fa-list-ul"></i> Minhas Campanhas</button>
            <button class="nav-btn" onclick="showPanel('ai', this)"><i class="fas fa-brain"></i> Configura√ß√£o IA</button>
            <button class="nav-btn" onclick="showPanel('logs', this)"><i class="fas fa-terminal"></i> Terminal Logs</button>
        </div>

        <!-- Panels Content -->
        <div class="panels-container">
            
            <!-- Dashboard -->
            <div id="dash" class="panel active">
                <div class="card">
                    <h2><i class="fas fa-wifi"></i> Conex√£o WhatsApp</h2>
                    <div class="qr-wrapper">
                        <img id="qr-img" style="display: none;">
                        <div id="connected-view" style="display: none; text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
                            <h3 style="margin:0">Bot Operacional</h3>
                            <p style="color: var(--text-muted);">Pronto para enviar mensagens e responder com IA.</p>
                        </div>
                        <p id="qr-msg" style="margin-top: 15px;">Aguardando QR Code...</p>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="card">
                        <h2><i class="fas fa-paper-plane"></i> Envios Totais</h2>
                        <h1 id="total-sent" style="font-size: 3rem; margin: 20px 0; color: var(--success)">0</h1>
                    </div>
                    <div class="card">
                        <h2><i class="fas fa-tasks"></i> Campanhas Ativas</h2>
                        <h1 id="total-active" style="font-size: 3rem; margin: 20px 0; color: var(--primary)">0</h1>
                    </div>
                </div>
            </div>

            <!-- Create Campaign -->
            <div id="create" class="panel">
                <div class="card">
                    <h2>Nova Campanha de Marketing</h2>
                    <form id="form-campaign">
                        <label>Nome da Campanha</label>
                        <input name="name" placeholder="Ex: Black Friday 2024" required>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>M√≠dia (Opcional)</label>
                                <input type="file" name="media" accept="image/*,video/*">
                            </div>
                            <div>
                                <label>Texto / Legenda</label>
                                <textarea name="text" rows="1" placeholder="Ol√°, confira nossas ofertas..."></textarea>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>Intervalo (Minutos)</label>
                                <input type="number" name="interval" value="30" min="1" required>
                            </div>
                            <div>
                                <label>Limite Di√°rio</label>
                                <input type="number" name="maxPerDay" value="100" required>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label>Hora de In√≠cio</label>
                                <input type="time" name="startTime" value="09:00" required>
                            </div>
                            <div>
                                <label>Dura√ß√£o (Dias)</label>
                                <input type="number" name="durationDays" value="5" required>
                            </div>
                        </div>

                        <label>Grupos Alvo</label>
                        <select name="targetGroups" class="group-select" multiple style="height: 150px; background: rgba(0,0,0,0.2);"></select>
                        
                        <button type="submit" class="btn-primary">Lan√ßar Campanha</button>
                    </form>
                </div>
            </div>

            <!-- List Campaigns -->
            <div id="list" class="panel">
                <div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <h2>Gerenciar Campanhas</h2>
                        <button onclick="loadCampaigns()" style="background:transparent; border:none; color:white; cursor:pointer"><i class="fas fa-sync"></i></button>
                    </div>
                    <div id="campaign-list-container" style="margin-top: 20px;">
                        <!-- JS fills this -->
                    </div>
                </div>
            </div>

            <!-- AI Config -->
            <div id="ai" class="panel">
                <div class="card">
                    <h2><i class="fas fa-robot"></i> C√©rebro da IA (Gemini)</h2>
                    <form id="form-ai">
                        <label>Prompt do Sistema (Personalidade e Dados)</label>
                        <textarea id="ai-context" rows="8" placeholder="Voc√™ √© um assistente virtual da loja X... Nossos produtos s√£o..."></textarea>
                        
                        <label>Grupos Permitidos (Whitelist)</label>
                        <select id="ai-groups" class="group-select" multiple style="height: 150px;"></select>
                        
                        <button type="submit" class="btn-primary">Salvar C√©rebro</button>
                    </form>
                </div>
            </div>

            <!-- Logs -->
            <div id="logs" class="panel">
                <div class="card">
                    <h2><i class="fas fa-code"></i> Terminal do Sistema</h2>
                    <div id="logs-container"></div>
                    <button onclick="document.getElementById('logs-container').innerHTML=''" style="margin-top:10px; background:transparent; border:1px solid #333; color:#ccc; padding:5px 10px; cursor:pointer; border-radius:5px;">Limpar Logs</button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    const socket = io();
    
    // --- UI LOGIC ---
    function showPanel(id, btn) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(btn) btn.classList.add('active');
        
        if(id === 'list') loadCampaigns();
        if(id === 'ai') loadAIConfig();
    }

    function updateStatusUI(status, isConnected) {
        const dot = document.getElementById('status-dot');
        const txt = document.getElementById('status-text');
        const qrImg = document.getElementById('qr-img');
        const connView = document.getElementById('connected-view');
        const msg = document.getElementById('qr-msg');

        txt.innerText = status;
        
        if (isConnected) {
            dot.classList.remove('offline');
            dot.classList.add('online');
            qrImg.style.display = 'none';
            connView.style.display = 'block';
            msg.style.display = 'none';
        } else {
            dot.classList.remove('online');
            dot.classList.add('offline');
            connView.style.display = 'none';
            msg.style.display = 'block';
            // Se estiver "Offline", QR fica oculto at√© o servidor mandar um novo
            if(status.includes('Offline') || status.includes('Desconectado')) {
                qrImg.style.display = 'none';
                msg.innerText = "Servidor desconectado ou reiniciando...";
            }
        }
    }

    // --- SOCKET EVENTS ---
    
    // CORRE√á√ÉO PRINCIPAL: Detecta queda de conex√£o do Socket.io
    socket.on('disconnect', () => {
        updateStatusUI('Offline (Socket) üî¥', false);
    });

    socket.on('connect', () => {
        // Quando reconecta o socket, pede status atual
    });

    socket.on('status', (s) => {
        const isOnline = s.includes('Online');
        updateStatusUI(s, isOnline);
    });

    socket.on('qr', (url) => {
        const qrImg = document.getElementById('qr-img');
        const msg = document.getElementById('qr-msg');
        if(url) {
            qrImg.src = url;
            qrImg.style.display = 'block';
            document.getElementById('connected-view').style.display = 'none';
            msg.style.display = 'block';
            msg.innerText = 'Escaneie o QR Code no WhatsApp';
        }
    });

    socket.on('groups', (groups) => {
        const html = groups.map(g => `<option value="${g.id}">${g.subject}</option>`).join('');
        document.querySelectorAll('.group-select').forEach(s => s.innerHTML = html);
    });

    socket.on('log', (msg) => {
        const box = document.getElementById('logs-container');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerText = msg;
        box.prepend(entry); // Log mais novo no topo
    });

    // --- FUNCTIONS ---
    
    function logout() {
        Swal.fire({
            title: 'Desconectar?',
            text: "Isso vai encerrar a sess√£o do WhatsApp.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            confirmButtonText: 'Sim, Desconectar'
        }).then((result) => {
            if (result.isConfirmed) {
                socket.emit('logout');
                updateStatusUI('Desconectando...', false);
            }
        })
    }

    // Form Campanhas
    document.getElementById('form-campaign').onsubmit = async function(e) {
        e.preventDefault();
        
        const select = this.querySelector('select');
        const selected = Array.from(select.selectedOptions).map(o => o.value);
        if(!selected.length) return Swal.fire('Erro', 'Selecione pelo menos um grupo!', 'error');

        const formData = new FormData(this);
        formData.delete('targetGroups');
        formData.append('targetGroups', JSON.stringify(selected));

        try {
            const res = await fetch('/api/campaign', { method: 'POST', body: formData });
            const json = await res.json();
            if(json.success) {
                Swal.fire('Sucesso!', 'Campanha criada e agendada.', 'success');
                this.reset();
                showPanel('list');
            } else {
                Swal.fire('Erro', json.error || 'Falha desconhecida', 'error');
            }
        } catch(err) { Swal.fire('Erro', err.message, 'error'); }
    };

    // Listar Campanhas
    async function loadCampaigns() {
        const res = await fetch('/api/campaigns');
        const data = await res.json();
        const container = document.getElementById('campaign-list-container');
        
        // Update stats dash
        document.getElementById('total-active').innerText = data.filter(c => c.active).length;
        document.getElementById('total-sent').innerText = data.reduce((a,b) => a + (b.stats.sentTotal || 0), 0);

        if(!data.length) return container.innerHTML = '<p class="text-center text-muted">Nenhuma campanha encontrada.</p>';

        container.innerHTML = data.map(c => {
            const progress = (c.stats.sentTotal / (c.targetGroups.length * 100)) * 100; // Fake progress logic, just visual
            return `
            <div class="campaign-item">
                <div>
                    <h3 style="margin:0; color:white;">${c.name}</h3>
                    <small style="color:var(--text-muted)">${c.text ? c.text.substring(0,40)+'...' : 'Apenas M√≠dia'}</small>
                    <div style="margin-top:5px; font-size:0.8rem; display:flex; gap:10px;">
                        <span><i class="fas fa-clock"></i> ${c.config.interval}min</span>
                        <span><i class="fas fa-check"></i> Enviados: ${c.stats.sentTotal}</span>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button onclick="toggleCamp('${c._id}', ${!c.active})" style="background:${c.active ? 'var(--success)' : '#475569'}; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">
                        ${c.active ? 'Ativa' : 'Pausada'}
                    </button>
                    <button onclick="deleteCamp('${c._id}')" style="background:transparent; border:none; color:var(--danger); cursor:pointer;"><i class="fas fa-trash"></i></button>
                </div>
            </div>`;
        }).join('');
    }

    async function toggleCamp(id, active) {
        await fetch('/api/toggle', { 
            method:'POST', headers:{'Content-Type':'application/json'}, 
            body:JSON.stringify({id, active}) 
        });
        loadCampaigns();
    }

    async function deleteCamp(id) {
        Swal.fire({
            title: 'Tem certeza?',
            text: "N√£o ser√° poss√≠vel reverter!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Sim, apagar'
        }).then(async (result) => {
            if (result.isConfirmed) {
                await fetch('/api/delete-campaign', { 
                    method:'POST', headers:{'Content-Type':'application/json'}, 
                    body:JSON.stringify({id}) 
                });
                loadCampaigns();
                Swal.fire('Deletado!', 'A campanha foi removida.', 'success');
            }
        })
    }

    // Config IA
    async function loadAIConfig() {
        const res = await fetch('/api/ai-config');
        const data = await res.json();
        if(data.systemInstruction) {
            document.getElementById('ai-context').value = data.systemInstruction;
            const select = document.getElementById('ai-groups');
            // Timeout pequeno para garantir que os grupos carregaram via socket
            setTimeout(() => {
                Array.from(select.options).forEach(opt => {
                    opt.selected = data.targetGroups.includes(opt.value);
                });
            }, 500);
        }
    }

    document.getElementById('form-ai').onsubmit = async function(e) {
        e.preventDefault();
        const context = document.getElementById('ai-context').value;
        const select = document.getElementById('ai-groups');
        const groups = Array.from(select.selectedOptions).map(o => o.value);

        await fetch('/api/ai-config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ systemInstruction: context, targetGroups: groups })
        });
        Swal.fire('Configurado!', 'A IA foi atualizada com sucesso.', 'success');
    };

</script>
</body>
</html>